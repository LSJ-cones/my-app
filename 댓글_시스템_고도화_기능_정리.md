# ğŸš€ ëŒ“ê¸€ ì‹œìŠ¤í…œ ê³ ë„í™” - ì¶”ê°€ëœ ê¸°ëŠ¥ë“¤

## ğŸ“‹ ê°œìš”
ì»¤ë°‹ ì´í›„ ì¶”ê°€ëœ ëŒ“ê¸€ ì‹œìŠ¤í…œ ê³ ë„í™” ê¸°ëŠ¥ë“¤ì„ ìƒì„¸íˆ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

---

## 1. ğŸ—ï¸ ìƒˆë¡œìš´ ì—”í‹°í‹° (Entities)

### 1.1 `CommentStatus.java` - ëŒ“ê¸€ ìƒíƒœ ê´€ë¦¬
```java
public enum CommentStatus {
    ACTIVE,     // í™œì„± ìƒíƒœ
    DELETED,    // ì‚­ì œëœ ìƒíƒœ (ì†Œí”„íŠ¸ ì‚­ì œ)
    REPORTED    // ì‹ ê³ ëœ ìƒíƒœ
}
```

### 1.2 `CommentReaction.java` - ëŒ“ê¸€ ë°˜ì‘ (ì¢‹ì•„ìš”/ì‹«ì–´ìš”)
```java
@Entity
@Table(uniqueConstraints = @UniqueConstraint(columnNames = {"comment_id", "user_id"}))
public class CommentReaction {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Enumerated(EnumType.STRING)
    private ReactionType type; // LIKE, DISLIKE
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "comment_id")
    private Comment comment;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;
    
    private LocalDateTime createdAt;
}
```

### 1.3 `ReactionType.java` - ë°˜ì‘ íƒ€ì…
```java
public enum ReactionType {
    LIKE,    // ì¢‹ì•„ìš”
    DISLIKE  // ì‹«ì–´ìš”
}
```

### 1.4 `CommentReport.java` - ëŒ“ê¸€ ì‹ ê³ 
```java
@Entity
public class CommentReport {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Enumerated(EnumType.STRING)
    private ReportReason reason; // SPAM, INAPPROPRIATE, HARASSMENT, OTHER
    
    @Column(columnDefinition = "TEXT")
    private String description;
    
    @Enumerated(EnumType.STRING)
    private ReportStatus status; // PENDING, RESOLVED, REJECTED
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "comment_id")
    private Comment comment;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "reporter_id")
    private User reporter;
    
    private LocalDateTime createdAt;
}
```

### 1.5 `ReportReason.java` - ì‹ ê³  ì‚¬ìœ 
```java
public enum ReportReason {
    SPAM,           // ìŠ¤íŒ¸
    INAPPROPRIATE,  // ë¶€ì ì ˆí•œ ë‚´ìš©
    HARASSMENT,     // ê´´ë¡­í˜
    OTHER           // ê¸°íƒ€
}
```

### 1.6 `ReportStatus.java` - ì‹ ê³  ì²˜ë¦¬ ìƒíƒœ
```java
public enum ReportStatus {
    PENDING,   // ëŒ€ê¸° ì¤‘
    RESOLVED,  // í•´ê²°ë¨
    REJECTED   // ê±°ë¶€ë¨
}
```

---

## 2. ğŸ”„ ê¸°ì¡´ ì—”í‹°í‹° í™•ì¥

### 2.1 `Comment.java` - ëŒ“ê¸€ ì—”í‹°í‹° í™•ì¥
```java
@Entity
public class Comment {
    // ê¸°ì¡´ í•„ë“œë“¤...
    
    // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œë“¤
    @Enumerated(EnumType.STRING)
    private CommentStatus status = CommentStatus.ACTIVE;
    
    private Integer likeCount = 0;
    private Integer dislikeCount = 0;
    
    // ëŒ€ëŒ“ê¸€ ê¸°ëŠ¥
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "parent_id")
    private Comment parent;
    
    @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Comment> replies = new ArrayList<>();
    
    // ë°˜ì‘ ë° ì‹ ê³  ê´€ê³„
    @OneToMany(mappedBy = "comment", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<CommentReaction> reactions = new HashSet<>();
    
    @OneToMany(mappedBy = "comment", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<CommentReport> reports = new HashSet<>();
    
    // ë¹„ì¦ˆë‹ˆìŠ¤ ë©”ì„œë“œë“¤
    public void incrementLikeCount() { this.likeCount++; }
    public void decrementLikeCount() { this.likeCount--; }
    public void incrementDislikeCount() { this.dislikeCount++; }
    public void decrementDislikeCount() { this.dislikeCount--; }
    public void markAsDeleted() { this.status = CommentStatus.DELETED; }
    public void markAsReported() { this.status = CommentStatus.REPORTED; }
}
```

---

## 3. ğŸ“¦ ìƒˆë¡œìš´ DTOë“¤

### 3.1 `CommentRequestDto.java` - ëŒ“ê¸€ ìƒì„±/ìˆ˜ì • ìš”ì²­
```java
public class CommentRequestDto {
    @NotBlank(message = "ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”")
    private String content;
    
    @NotNull(message = "ê²Œì‹œê¸€ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”")
    private Long postId;
    
    private Long parentId; // ëŒ€ëŒ“ê¸€ì¸ ê²½ìš° ë¶€ëª¨ ëŒ“ê¸€ ID
}
```

### 3.2 `CommentResponseDto.java` - ëŒ“ê¸€ ì‘ë‹µ (í™•ì¥)
```java
public class CommentResponseDto {
    // ê¸°ì¡´ í•„ë“œë“¤...
    private Long id;
    private String content;
    private String author;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œë“¤
    private CommentStatus status;
    private Integer likeCount;
    private Integer dislikeCount;
    private Long parentId;
    private List<CommentResponseDto> replies;
    private Boolean isLiked;
    private Boolean isDisliked;
    private String authorName;
    private String authorEmail;
}
```

### 3.3 `CommentReactionDto.java` - ëŒ“ê¸€ ë°˜ì‘ ìš”ì²­
```java
public class CommentReactionDto {
    @NotNull(message = "ëŒ“ê¸€ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”")
    private Long commentId;
    
    @NotNull(message = "ë°˜ì‘ íƒ€ì…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”")
    private ReactionType type;
}
```

### 3.4 `CommentReportDto.java` - ëŒ“ê¸€ ì‹ ê³  ìš”ì²­
```java
public class CommentReportDto {
    @NotNull(message = "ëŒ“ê¸€ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”")
    private Long commentId;
    
    @NotNull(message = "ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”")
    private ReportReason reason;
    
    private String description;
}
```

---

## 4. ğŸ—„ï¸ ìƒˆë¡œìš´ Repositoryë“¤

### 4.1 `CommentReactionRepository.java`
```java
@Repository
public interface CommentReactionRepository extends JpaRepository<CommentReaction, Long> {
    Optional<CommentReaction> findByCommentAndUser(Comment comment, User user);
    long countByCommentAndType(Comment comment, ReactionType type);
    boolean existsByCommentAndUser(Comment comment, User user);
}
```

### 4.2 `CommentReportRepository.java`
```java
@Repository
public interface CommentReportRepository extends JpaRepository<CommentReport, Long> {
    List<CommentReport> findByCommentAndReporter(Comment comment, User reporter);
    List<CommentReport> findByStatus(ReportStatus status);
    long countByComment(Comment comment);
}
```

### 4.3 `CommentRepository.java` - ê¸°ì¡´ Repository í™•ì¥
```java
@Repository
public interface CommentRepository extends JpaRepository<Comment, Long> {
    // ê¸°ì¡´ ë©”ì„œë“œë“¤...
    List<Comment> findByPostId(Long postId);
    
    // ìƒˆë¡œ ì¶”ê°€ëœ ë©”ì„œë“œë“¤
    List<Comment> findByPostIdAndStatusAndParentIsNull(Long postId, CommentStatus status);
    Page<Comment> findByPostIdAndParentIsNull(Long postId, Pageable pageable);
    List<Comment> findByParentId(Long parentId);
    Page<Comment> findByUserId(Long userId, Pageable pageable);
    Page<Comment> findByStatus(CommentStatus status, Pageable pageable);
    List<Comment> findByStatusOrderByLikeCountDesc(CommentStatus status);
    List<Comment> findByStatusOrderByCreatedAtDesc(CommentStatus status);
}
```

---

## 5. ğŸ› ï¸ CommentService í™•ì¥

### 5.1 ì£¼ìš” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë“¤:

#### ëŒ“ê¸€ ìƒì„±/ìˆ˜ì •/ì‚­ì œ
```java
// ëŒ“ê¸€ ìƒì„±
public CommentResponseDto createComment(CommentRequestDto requestDto)

// ëŒ“ê¸€ ìˆ˜ì •
public CommentResponseDto updateComment(Long commentId, CommentRequestDto requestDto)

// ëŒ“ê¸€ ì‚­ì œ (ì†Œí”„íŠ¸ ì‚­ì œ)
public void deleteComment(Long commentId)
```

#### ëŒ€ëŒ“ê¸€ ê¸°ëŠ¥
```java
// ëŒ€ëŒ“ê¸€ ì¡°íšŒ
public List<CommentResponseDto> getRepliesByCommentId(Long commentId)
```

#### ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë°˜ì‘
```java
// ëŒ“ê¸€ ë°˜ì‘ (í† ê¸€ ê¸°ëŠ¥ í¬í•¨)
public CommentResponseDto reactToComment(CommentReactionDto reactionDto)
```

#### ëŒ“ê¸€ ì‹ ê³ 
```java
// ëŒ“ê¸€ ì‹ ê³  (ì¤‘ë³µ ì‹ ê³  ë°©ì§€)
public void reportComment(CommentReportDto reportDto)

// ì‹ ê³  ì²˜ë¦¬ (ê´€ë¦¬ììš©)
public void handleReport(Long reportId, ReportStatus status)
```

#### ì¡°íšŒ ê¸°ëŠ¥ë“¤
```java
// í˜ì´ì§• ì§€ì› ëŒ“ê¸€ ì¡°íšŒ
public PageResponseDto<CommentResponseDto> getCommentsByPostIdWithPaging(Long postId, PageRequestDto pageRequestDto)

// ì‚¬ìš©ìë³„ ëŒ“ê¸€ ì¡°íšŒ
public PageResponseDto<CommentResponseDto> getUserComments(Long userId, PageRequestDto pageRequestDto)

// ì‹ ê³ ëœ ëŒ“ê¸€ ì¡°íšŒ (ê´€ë¦¬ììš©)
public PageResponseDto<CommentResponseDto> getReportedComments(PageRequestDto pageRequestDto)
```

---

## 6. ğŸŒ CommentController í™•ì¥

### 6.1 ìƒˆë¡œìš´ API ì—”ë“œí¬ì¸íŠ¸ë“¤:
```java
@RestController
@RequestMapping("/api/comments")
public class CommentController {
    
    // ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ë“¤...
    @GetMapping("/post/{postId}")
    public ResponseEntity<List<CommentResponseDto>> getCommentsByPostId(@PathVariable Long postId);
    
    @GetMapping("/post/{postId}/paging")
    public ResponseEntity<PageResponseDto<CommentResponseDto>> getCommentsByPostIdWithPaging(
        @PathVariable Long postId, PageRequestDto pageRequestDto);
    
    // ìƒˆë¡œ ì¶”ê°€ëœ ì—”ë“œí¬ì¸íŠ¸ë“¤
    @PostMapping
    public ResponseEntity<CommentResponseDto> createComment(@RequestBody CommentRequestDto requestDto);
    
    @PutMapping("/{commentId}")
    public ResponseEntity<CommentResponseDto> updateComment(@PathVariable Long commentId, @RequestBody CommentRequestDto requestDto);
    
    @DeleteMapping("/{commentId}")
    public ResponseEntity<Void> deleteComment(@PathVariable Long commentId);
    
    @PostMapping("/{commentId}/reaction")
    public ResponseEntity<CommentResponseDto> reactToComment(@PathVariable Long commentId, @RequestBody CommentReactionDto reactionDto);
    
    @PostMapping("/{commentId}/report")
    public ResponseEntity<Void> reportComment(@PathVariable Long commentId, @RequestBody CommentReportDto reportDto);
    
    @GetMapping("/replies/{commentId}")
    public ResponseEntity<List<CommentResponseDto>> getRepliesByCommentId(@PathVariable Long commentId);
    
    @GetMapping("/user/{userId}")
    public ResponseEntity<PageResponseDto<CommentResponseDto>> getUserComments(@PathVariable Long userId, PageRequestDto pageRequestDto);
    
    @GetMapping("/reported")
    public ResponseEntity<PageResponseDto<CommentResponseDto>> getReportedComments(PageRequestDto pageRequestDto);
    
    @PutMapping("/reports/{reportId}/status")
    public ResponseEntity<Void> handleReport(@PathVariable Long reportId, @RequestParam ReportStatus status);
}
```

---

## 7. ğŸ—ƒï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸

### 7.1 `update_comment_schema.sql`
```sql
-- ëŒ“ê¸€ í…Œì´ë¸”ì— ìƒˆë¡œìš´ ì»¬ëŸ¼ë“¤ ì¶”ê°€
ALTER TABLE comment ADD COLUMN IF NOT EXISTS status VARCHAR(255) DEFAULT 'ACTIVE';
ALTER TABLE comment ADD COLUMN IF NOT EXISTS like_count INTEGER DEFAULT 0;
ALTER TABLE comment ADD COLUMN IF NOT EXISTS dislike_count INTEGER DEFAULT 0;
ALTER TABLE comment ADD COLUMN IF NOT EXISTS parent_id BIGINT;
ALTER TABLE comment ADD COLUMN IF NOT EXISTS user_id BIGINT;

-- ëŒ“ê¸€ ë°˜ì‘ í…Œì´ë¸” ìƒì„±
CREATE TABLE IF NOT EXISTS comment_reactions (
    id BIGSERIAL PRIMARY KEY,
    type VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    comment_id BIGINT REFERENCES comment(id) ON DELETE CASCADE,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE(comment_id, user_id)
);

-- ëŒ“ê¸€ ì‹ ê³  í…Œì´ë¸” ìƒì„±
CREATE TABLE IF NOT EXISTS comment_reports (
    id BIGSERIAL PRIMARY KEY,
    reason VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(255) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    comment_id BIGINT REFERENCES comment(id) ON DELETE CASCADE,
    reporter_id BIGINT REFERENCES users(id) ON DELETE CASCADE
);

-- ì™¸ë˜í‚¤ ì œì•½ì¡°ê±´ ì„¤ì •
DO $$ BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.table_constraints WHERE constraint_name = 'fk_comment_parent') THEN
        ALTER TABLE comment ADD CONSTRAINT fk_comment_parent FOREIGN KEY (parent_id) REFERENCES comment(id) ON DELETE CASCADE;
    END IF;
END $$;

DO $$ BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.table_constraints WHERE constraint_name = 'fk_comment_user') THEN
        ALTER TABLE comment ADD CONSTRAINT fk_comment_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
    END IF;
END $$;
```

### 7.2 `insert_dummy_comments.sql`
```sql
-- í…ŒìŠ¤íŠ¸ìš© ëŒ“ê¸€ ë°ì´í„° ì‚½ì…
INSERT INTO comment (content, post_id, user_id, author, status, like_count, dislike_count, created_at, updated_at)
SELECT 'í…ŒìŠ¤íŠ¸ ëŒ“ê¸€ ' || i, 1, u.id, u.username, 'ACTIVE', 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
FROM generate_series(1, 10) i
CROSS JOIN (SELECT id, username FROM users WHERE username = 'admin' LIMIT 1) u;

-- ëŒ“ê¸€ ë°˜ì‘ ë°ì´í„° ì‚½ì…
INSERT INTO comment_reactions (type, comment_id, user_id, created_at)
SELECT 'LIKE', c.id, u.id, CURRENT_TIMESTAMP
FROM comment c
CROSS JOIN (SELECT id FROM users WHERE username = 'admin' LIMIT 1) u
WHERE c.id <= 5;

-- ëŒ“ê¸€ ì‹ ê³  ë°ì´í„° ì‚½ì…
INSERT INTO comment_reports (reason, description, comment_id, reporter_id, created_at)
SELECT 'SPAM', 'ìŠ¤íŒ¸ ëŒ“ê¸€ì…ë‹ˆë‹¤.', c.id, u.id, CURRENT_TIMESTAMP
FROM comment c
CROSS JOIN (SELECT id FROM users WHERE username = 'user' LIMIT 1) u
WHERE c.id = 1;
```

---

## 8. ğŸ”§ ì£¼ìš” ê°œì„ ì‚¬í•­

### 8.1 ë²„ê·¸ ìˆ˜ì •
- **NullPointerException í•´ê²°** - replies null ì²´í¬ ì¶”ê°€
- **ArrayList import ì¶”ê°€** - ì»´íŒŒì¼ ì˜¤ë¥˜ í•´ê²°

### 8.2 ë³´ì•ˆ ë° ì¸ì¦
- **JWT ì¸ì¦ ì„ì‹œ ë¹„í™œì„±í™”** - í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶•
- **ê¶Œí•œ ê´€ë¦¬ ê°•í™”** - ì‘ì„±ì/ê´€ë¦¬ì ê¶Œí•œ ì²´í¬

### 8.3 ë°ì´í„° ê´€ë¦¬
- **ì†Œí”„íŠ¸ ì‚­ì œ êµ¬í˜„** - ë°ì´í„° ë³´ì¡´
- **ì¤‘ë³µ ì‹ ê³  ë°©ì§€** - ì‚¬ìš©ìë³„ ì‹ ê³  ì œí•œ

### 8.4 ì„±ëŠ¥ ìµœì í™”
- **í˜ì´ì§• ì§€ì›** - ëŒ€ëŸ‰ ëŒ“ê¸€ ì²˜ë¦¬
- **ì§€ì—° ë¡œë”©** - ì„±ëŠ¥ í–¥ìƒ

---

## 9. ğŸ“Š API í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ

### 9.1 ëŒ“ê¸€ ìƒì„±
```bash
POST /api/comments
Content-Type: application/json

{
  "content": "í…ŒìŠ¤íŠ¸ ëŒ“ê¸€ì…ë‹ˆë‹¤!",
  "postId": 1
}
```

### 9.2 ëŒ€ëŒ“ê¸€ ìƒì„±
```bash
POST /api/comments
Content-Type: application/json

{
  "content": "ëŒ€ëŒ“ê¸€ì…ë‹ˆë‹¤!",
  "postId": 1,
  "parentId": 1
}
```

### 9.3 ëŒ“ê¸€ ì¢‹ì•„ìš”
```bash
POST /api/comments/1/reaction
Content-Type: application/json

{
  "type": "LIKE"
}
```

### 9.4 ëŒ“ê¸€ ì‹ ê³ 
```bash
POST /api/comments/1/report
Content-Type: application/json

{
  "reason": "SPAM",
  "description": "ìŠ¤íŒ¸ ëŒ“ê¸€ì…ë‹ˆë‹¤."
}
```

### 9.5 ëŒ“ê¸€ ì¡°íšŒ (í˜ì´ì§•)
```bash
GET /api/comments/post/1/paging?page=0&size=10&sortBy=createdAt&sortDirection=desc
```

---

## 10. ğŸ¯ êµ¬í˜„ëœ ì£¼ìš” ê¸°ëŠ¥ë“¤

### âœ… ì™„ë£Œëœ ê¸°ëŠ¥ë“¤
1. **ëŒ€ëŒ“ê¸€ ì‹œìŠ¤í…œ** - ê³„ì¸µí˜• ëŒ“ê¸€ êµ¬ì¡°
2. **ì¢‹ì•„ìš”/ì‹«ì–´ìš” ê¸°ëŠ¥** - ì‚¬ìš©ì ë°˜ì‘ ì‹œìŠ¤í…œ
3. **ëŒ“ê¸€ ì‹ ê³  ê¸°ëŠ¥** - ë¶€ì ì ˆí•œ ëŒ“ê¸€ ì‹ ê³  ë° ê´€ë¦¬
4. **ëŒ“ê¸€ ìƒíƒœ ê´€ë¦¬** - ACTIVE, DELETED, REPORTED ìƒíƒœ
5. **í˜ì´ì§• ì§€ì›** - ëŒ€ëŸ‰ ëŒ“ê¸€ ì²˜ë¦¬
6. **ê¶Œí•œ ê´€ë¦¬** - ì‘ì„±ì/ê´€ë¦¬ì ê¶Œí•œ ì²´í¬
7. **ì†Œí”„íŠ¸ ì‚­ì œ** - ë°ì´í„° ë³´ì¡´
8. **ì¤‘ë³µ ì‹ ê³  ë°©ì§€** - ì‚¬ìš©ìë³„ ì‹ ê³  ì œí•œ

---

## ğŸ“ ì‘ì„±ì¼
- **ì‘ì„±ì¼**: 2025ë…„ 8ì›” 12ì¼
- **ë²„ì „**: 1.0
- **ì‘ì„±ì**: AI Assistant
- **í”„ë¡œì íŠ¸**: Blog Toy Project
