# 🚀 댓글 시스템 고도화 - 추가된 기능들

## 📋 개요
커밋 이후 추가된 댓글 시스템 고도화 기능들을 상세히 정리한 문서입니다.

---

## 1. 🏗️ 새로운 엔티티 (Entities)

### 1.1 `CommentStatus.java` - 댓글 상태 관리
```java
public enum CommentStatus {
    ACTIVE,     // 활성 상태
    DELETED,    // 삭제된 상태 (소프트 삭제)
    REPORTED    // 신고된 상태
}
```

### 1.2 `CommentReaction.java` - 댓글 반응 (좋아요/싫어요)
```java
@Entity
@Table(uniqueConstraints = @UniqueConstraint(columnNames = {"comment_id", "user_id"}))
public class CommentReaction {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Enumerated(EnumType.STRING)
    private ReactionType type; // LIKE, DISLIKE
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "comment_id")
    private Comment comment;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private User user;
    
    private LocalDateTime createdAt;
}
```

### 1.3 `ReactionType.java` - 반응 타입
```java
public enum ReactionType {
    LIKE,    // 좋아요
    DISLIKE  // 싫어요
}
```

### 1.4 `CommentReport.java` - 댓글 신고
```java
@Entity
public class CommentReport {
    @Id @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Enumerated(EnumType.STRING)
    private ReportReason reason; // SPAM, INAPPROPRIATE, HARASSMENT, OTHER
    
    @Column(columnDefinition = "TEXT")
    private String description;
    
    @Enumerated(EnumType.STRING)
    private ReportStatus status; // PENDING, RESOLVED, REJECTED
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "comment_id")
    private Comment comment;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "reporter_id")
    private User reporter;
    
    private LocalDateTime createdAt;
}
```

### 1.5 `ReportReason.java` - 신고 사유
```java
public enum ReportReason {
    SPAM,           // 스팸
    INAPPROPRIATE,  // 부적절한 내용
    HARASSMENT,     // 괴롭힘
    OTHER           // 기타
}
```

### 1.6 `ReportStatus.java` - 신고 처리 상태
```java
public enum ReportStatus {
    PENDING,   // 대기 중
    RESOLVED,  // 해결됨
    REJECTED   // 거부됨
}
```

---

## 2. 🔄 기존 엔티티 확장

### 2.1 `Comment.java` - 댓글 엔티티 확장
```java
@Entity
public class Comment {
    // 기존 필드들...
    
    // 새로 추가된 필드들
    @Enumerated(EnumType.STRING)
    private CommentStatus status = CommentStatus.ACTIVE;
    
    private Integer likeCount = 0;
    private Integer dislikeCount = 0;
    
    // 대댓글 기능
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "parent_id")
    private Comment parent;
    
    @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Comment> replies = new ArrayList<>();
    
    // 반응 및 신고 관계
    @OneToMany(mappedBy = "comment", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<CommentReaction> reactions = new HashSet<>();
    
    @OneToMany(mappedBy = "comment", cascade = CascadeType.ALL, orphanRemoval = true)
    private Set<CommentReport> reports = new HashSet<>();
    
    // 비즈니스 메서드들
    public void incrementLikeCount() { this.likeCount++; }
    public void decrementLikeCount() { this.likeCount--; }
    public void incrementDislikeCount() { this.dislikeCount++; }
    public void decrementDislikeCount() { this.dislikeCount--; }
    public void markAsDeleted() { this.status = CommentStatus.DELETED; }
    public void markAsReported() { this.status = CommentStatus.REPORTED; }
}
```

---

## 3. 📦 새로운 DTO들

### 3.1 `CommentRequestDto.java` - 댓글 생성/수정 요청
```java
public class CommentRequestDto {
    @NotBlank(message = "댓글 내용을 입력해주세요")
    private String content;
    
    @NotNull(message = "게시글 ID를 입력해주세요")
    private Long postId;
    
    private Long parentId; // 대댓글인 경우 부모 댓글 ID
}
```

### 3.2 `CommentResponseDto.java` - 댓글 응답 (확장)
```java
public class CommentResponseDto {
    // 기존 필드들...
    private Long id;
    private String content;
    private String author;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    
    // 새로 추가된 필드들
    private CommentStatus status;
    private Integer likeCount;
    private Integer dislikeCount;
    private Long parentId;
    private List<CommentResponseDto> replies;
    private Boolean isLiked;
    private Boolean isDisliked;
    private String authorName;
    private String authorEmail;
}
```

### 3.3 `CommentReactionDto.java` - 댓글 반응 요청
```java
public class CommentReactionDto {
    @NotNull(message = "댓글 ID를 입력해주세요")
    private Long commentId;
    
    @NotNull(message = "반응 타입을 입력해주세요")
    private ReactionType type;
}
```

### 3.4 `CommentReportDto.java` - 댓글 신고 요청
```java
public class CommentReportDto {
    @NotNull(message = "댓글 ID를 입력해주세요")
    private Long commentId;
    
    @NotNull(message = "신고 사유를 선택해주세요")
    private ReportReason reason;
    
    private String description;
}
```

---

## 4. 🗄️ 새로운 Repository들

### 4.1 `CommentReactionRepository.java`
```java
@Repository
public interface CommentReactionRepository extends JpaRepository<CommentReaction, Long> {
    Optional<CommentReaction> findByCommentAndUser(Comment comment, User user);
    long countByCommentAndType(Comment comment, ReactionType type);
    boolean existsByCommentAndUser(Comment comment, User user);
}
```

### 4.2 `CommentReportRepository.java`
```java
@Repository
public interface CommentReportRepository extends JpaRepository<CommentReport, Long> {
    List<CommentReport> findByCommentAndReporter(Comment comment, User reporter);
    List<CommentReport> findByStatus(ReportStatus status);
    long countByComment(Comment comment);
}
```

### 4.3 `CommentRepository.java` - 기존 Repository 확장
```java
@Repository
public interface CommentRepository extends JpaRepository<Comment, Long> {
    // 기존 메서드들...
    List<Comment> findByPostId(Long postId);
    
    // 새로 추가된 메서드들
    List<Comment> findByPostIdAndStatusAndParentIsNull(Long postId, CommentStatus status);
    Page<Comment> findByPostIdAndParentIsNull(Long postId, Pageable pageable);
    List<Comment> findByParentId(Long parentId);
    Page<Comment> findByUserId(Long userId, Pageable pageable);
    Page<Comment> findByStatus(CommentStatus status, Pageable pageable);
    List<Comment> findByStatusOrderByLikeCountDesc(CommentStatus status);
    List<Comment> findByStatusOrderByCreatedAtDesc(CommentStatus status);
}
```

---

## 5. 🛠️ CommentService 확장

### 5.1 주요 비즈니스 로직들:

#### 댓글 생성/수정/삭제
```java
// 댓글 생성
public CommentResponseDto createComment(CommentRequestDto requestDto)

// 댓글 수정
public CommentResponseDto updateComment(Long commentId, CommentRequestDto requestDto)

// 댓글 삭제 (소프트 삭제)
public void deleteComment(Long commentId)
```

#### 대댓글 기능
```java
// 대댓글 조회
public List<CommentResponseDto> getRepliesByCommentId(Long commentId)
```

#### 좋아요/싫어요 반응
```java
// 댓글 반응 (토글 기능 포함)
public CommentResponseDto reactToComment(CommentReactionDto reactionDto)
```

#### 댓글 신고
```java
// 댓글 신고 (중복 신고 방지)
public void reportComment(CommentReportDto reportDto)

// 신고 처리 (관리자용)
public void handleReport(Long reportId, ReportStatus status)
```

#### 조회 기능들
```java
// 페이징 지원 댓글 조회
public PageResponseDto<CommentResponseDto> getCommentsByPostIdWithPaging(Long postId, PageRequestDto pageRequestDto)

// 사용자별 댓글 조회
public PageResponseDto<CommentResponseDto> getUserComments(Long userId, PageRequestDto pageRequestDto)

// 신고된 댓글 조회 (관리자용)
public PageResponseDto<CommentResponseDto> getReportedComments(PageRequestDto pageRequestDto)
```

---

## 6. 🌐 CommentController 확장

### 6.1 새로운 API 엔드포인트들:
```java
@RestController
@RequestMapping("/api/comments")
public class CommentController {
    
    // 기존 엔드포인트들...
    @GetMapping("/post/{postId}")
    public ResponseEntity<List<CommentResponseDto>> getCommentsByPostId(@PathVariable Long postId);
    
    @GetMapping("/post/{postId}/paging")
    public ResponseEntity<PageResponseDto<CommentResponseDto>> getCommentsByPostIdWithPaging(
        @PathVariable Long postId, PageRequestDto pageRequestDto);
    
    // 새로 추가된 엔드포인트들
    @PostMapping
    public ResponseEntity<CommentResponseDto> createComment(@RequestBody CommentRequestDto requestDto);
    
    @PutMapping("/{commentId}")
    public ResponseEntity<CommentResponseDto> updateComment(@PathVariable Long commentId, @RequestBody CommentRequestDto requestDto);
    
    @DeleteMapping("/{commentId}")
    public ResponseEntity<Void> deleteComment(@PathVariable Long commentId);
    
    @PostMapping("/{commentId}/reaction")
    public ResponseEntity<CommentResponseDto> reactToComment(@PathVariable Long commentId, @RequestBody CommentReactionDto reactionDto);
    
    @PostMapping("/{commentId}/report")
    public ResponseEntity<Void> reportComment(@PathVariable Long commentId, @RequestBody CommentReportDto reportDto);
    
    @GetMapping("/replies/{commentId}")
    public ResponseEntity<List<CommentResponseDto>> getRepliesByCommentId(@PathVariable Long commentId);
    
    @GetMapping("/user/{userId}")
    public ResponseEntity<PageResponseDto<CommentResponseDto>> getUserComments(@PathVariable Long userId, PageRequestDto pageRequestDto);
    
    @GetMapping("/reported")
    public ResponseEntity<PageResponseDto<CommentResponseDto>> getReportedComments(PageRequestDto pageRequestDto);
    
    @PutMapping("/reports/{reportId}/status")
    public ResponseEntity<Void> handleReport(@PathVariable Long reportId, @RequestParam ReportStatus status);
}
```

---

## 7. 🗃️ 데이터베이스 스키마 업데이트

### 7.1 `update_comment_schema.sql`
```sql
-- 댓글 테이블에 새로운 컬럼들 추가
ALTER TABLE comment ADD COLUMN IF NOT EXISTS status VARCHAR(255) DEFAULT 'ACTIVE';
ALTER TABLE comment ADD COLUMN IF NOT EXISTS like_count INTEGER DEFAULT 0;
ALTER TABLE comment ADD COLUMN IF NOT EXISTS dislike_count INTEGER DEFAULT 0;
ALTER TABLE comment ADD COLUMN IF NOT EXISTS parent_id BIGINT;
ALTER TABLE comment ADD COLUMN IF NOT EXISTS user_id BIGINT;

-- 댓글 반응 테이블 생성
CREATE TABLE IF NOT EXISTS comment_reactions (
    id BIGSERIAL PRIMARY KEY,
    type VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    comment_id BIGINT REFERENCES comment(id) ON DELETE CASCADE,
    user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE(comment_id, user_id)
);

-- 댓글 신고 테이블 생성
CREATE TABLE IF NOT EXISTS comment_reports (
    id BIGSERIAL PRIMARY KEY,
    reason VARCHAR(255) NOT NULL,
    description TEXT,
    status VARCHAR(255) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    comment_id BIGINT REFERENCES comment(id) ON DELETE CASCADE,
    reporter_id BIGINT REFERENCES users(id) ON DELETE CASCADE
);

-- 외래키 제약조건 설정
DO $$ BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.table_constraints WHERE constraint_name = 'fk_comment_parent') THEN
        ALTER TABLE comment ADD CONSTRAINT fk_comment_parent FOREIGN KEY (parent_id) REFERENCES comment(id) ON DELETE CASCADE;
    END IF;
END $$;

DO $$ BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.table_constraints WHERE constraint_name = 'fk_comment_user') THEN
        ALTER TABLE comment ADD CONSTRAINT fk_comment_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE;
    END IF;
END $$;
```

### 7.2 `insert_dummy_comments.sql`
```sql
-- 테스트용 댓글 데이터 삽입
INSERT INTO comment (content, post_id, user_id, author, status, like_count, dislike_count, created_at, updated_at)
SELECT '테스트 댓글 ' || i, 1, u.id, u.username, 'ACTIVE', 0, 0, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
FROM generate_series(1, 10) i
CROSS JOIN (SELECT id, username FROM users WHERE username = 'admin' LIMIT 1) u;

-- 댓글 반응 데이터 삽입
INSERT INTO comment_reactions (type, comment_id, user_id, created_at)
SELECT 'LIKE', c.id, u.id, CURRENT_TIMESTAMP
FROM comment c
CROSS JOIN (SELECT id FROM users WHERE username = 'admin' LIMIT 1) u
WHERE c.id <= 5;

-- 댓글 신고 데이터 삽입
INSERT INTO comment_reports (reason, description, comment_id, reporter_id, created_at)
SELECT 'SPAM', '스팸 댓글입니다.', c.id, u.id, CURRENT_TIMESTAMP
FROM comment c
CROSS JOIN (SELECT id FROM users WHERE username = 'user' LIMIT 1) u
WHERE c.id = 1;
```

---

## 8. 🔧 주요 개선사항

### 8.1 버그 수정
- **NullPointerException 해결** - replies null 체크 추가
- **ArrayList import 추가** - 컴파일 오류 해결

### 8.2 보안 및 인증
- **JWT 인증 임시 비활성화** - 테스트 환경 구축
- **권한 관리 강화** - 작성자/관리자 권한 체크

### 8.3 데이터 관리
- **소프트 삭제 구현** - 데이터 보존
- **중복 신고 방지** - 사용자별 신고 제한

### 8.4 성능 최적화
- **페이징 지원** - 대량 댓글 처리
- **지연 로딩** - 성능 향상

---

## 9. 📊 API 테스트 예시

### 9.1 댓글 생성
```bash
POST /api/comments
Content-Type: application/json

{
  "content": "테스트 댓글입니다!",
  "postId": 1
}
```

### 9.2 대댓글 생성
```bash
POST /api/comments
Content-Type: application/json

{
  "content": "대댓글입니다!",
  "postId": 1,
  "parentId": 1
}
```

### 9.3 댓글 좋아요
```bash
POST /api/comments/1/reaction
Content-Type: application/json

{
  "type": "LIKE"
}
```

### 9.4 댓글 신고
```bash
POST /api/comments/1/report
Content-Type: application/json

{
  "reason": "SPAM",
  "description": "스팸 댓글입니다."
}
```

### 9.5 댓글 조회 (페이징)
```bash
GET /api/comments/post/1/paging?page=0&size=10&sortBy=createdAt&sortDirection=desc
```

---

## 10. 🎯 구현된 주요 기능들

### ✅ 완료된 기능들
1. **대댓글 시스템** - 계층형 댓글 구조
2. **좋아요/싫어요 기능** - 사용자 반응 시스템
3. **댓글 신고 기능** - 부적절한 댓글 신고 및 관리
4. **댓글 상태 관리** - ACTIVE, DELETED, REPORTED 상태
5. **페이징 지원** - 대량 댓글 처리
6. **권한 관리** - 작성자/관리자 권한 체크
7. **소프트 삭제** - 데이터 보존
8. **중복 신고 방지** - 사용자별 신고 제한

---

## 📝 작성일
- **작성일**: 2025년 8월 12일
- **버전**: 1.0
- **작성자**: AI Assistant
- **프로젝트**: Blog Toy Project
